<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Timetable</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: transparent;
            padding: 10px;
        }

        .container {
            max-width: 100%;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tab-button {
            padding: 8px 16px;
            border: 1px solid var(--border-color, #e0e0e0);
            background: var(--bg-secondary, white);
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary, #000);
        }

        .tab-button.active {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .timetable-grid {
            display: grid;
            grid-template-columns: 70px repeat(5, 1fr);
            gap: 8px;
            background: transparent;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color, #e0e0e0);
        }

        .time-label {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-secondary, #666);
            font-weight: 500;
        }

        .day-header {
            background: var(--bg-tertiary, #f8f9fa);
            border: 1px solid var(--border-color, #e0e0e0);
            padding: 10px;
            text-align: center;
            font-weight: 600;
            border-radius: 4px;
            font-size: 14px;
            color: var(--text-primary, #000);
        }

        .time-slot {
            min-height: 50px;
            border: 1px dashed var(--border-light, #ddd);
            border-radius: 4px;
            padding: 4px;
            transition: all 0.2s;
            background: var(--bg-primary, transparent);
        }

        .time-slot:hover {
            background: var(--bg-hover, #f8f9fa);
            border-color: #0066cc;
        }

        .time-slot.drag-over {
            background: #e3f2fd;
            border-color: #0066cc;
            border-style: solid;
        }

        .event-card {
            padding: 8px;
            border-radius: 4px;
            cursor: move;
            font-size: 12px;
            margin-bottom: 4px;
            border: 1px solid;
        }

        .event-card:hover {
            opacity: 0.9;
        }

        .event-card.dragging {
            opacity: 0.4;
        }

        .event-card.compulsory {
            background: #ffebee;
            border-color: #ef5350;
            color: #c62828;
            cursor: not-allowed;
        }

        .event-card.activity {
            background: #e3f2fd;
            border-color: #42a5f5;
            color: #1565c0;
        }
        
        .event-card.activity.past-deadline {
            background: #fff3e0;
            border-color: #ff9800;
            color: #e65100;
            border-width: 2px;
            border-style: dashed;
        }

        .event-card.break {
            background: var(--break-bg, #f5f5f5);
            border-color: var(--break-border, #bdbdbd);
            color: var(--break-text, #616161);
        }

        .event-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .event-time {
            font-size: 11px;
            opacity: 0.8;
        }

        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        button {
            padding: 8px 16px;
            border: 1px solid var(--border-color, #e0e0e0);
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            background: var(--bg-secondary, white);
            transition: all 0.2s;
            color: var(--text-primary, #000);
        }

        button:hover {
            background: var(--bg-hover, #f8f9fa);
        }

        .btn-save {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .btn-save:hover {
            background: #43a047;
        }

        .btn-reset {
            background: #ff9800;
            color: white;
            border-color: #ff9800;
        }

        .btn-reset:hover {
            background: #fb8c00;
        }

        .day-list {
            background: var(--bg-secondary, white);
            border: 1px solid var(--border-color, #e0e0e0);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .day-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color, #e0e0e0);
            color: var(--text-primary, #000);
        }

        .event-list-item {
            padding: 10px;
            margin-bottom: 6px;
            border-radius: 4px;
            border-left: 3px solid;
        }

        .event-list-item.compulsory {
            background: #ffebee;
            border-color: #ef5350;
        }

        .event-list-item.activity {
            background: #e3f2fd;
            border-color: #42a5f5;
        }
        
        .event-list-item.activity.past-deadline {
            background: #fff3e0;
            border-color: #ff9800;
        }

        .event-list-item.break {
            background: var(--break-bg, #f5f5f5);
            border-color: var(--break-border, #bdbdbd);
        }

        .event-list-item strong {
            font-size: 14px;
            display: block;
            margin-bottom: 4px;
            color: var(--text-primary, #000);
        }

        .event-list-item span {
            font-size: 12px;
            color: var(--text-secondary, #666);
        }

        .empty-day {
            color: var(--text-muted, #999);
            font-style: italic;
            padding: 12px;
            text-align: center;
            font-size: 13px;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: transparent;
                --bg-secondary: #1e1e1e;
                --bg-tertiary: #2d2d2d;
                --bg-hover: #2d2d2d;
                --text-primary: #e0e0e0;
                --text-secondary: #a0a0a0;
                --text-muted: #666;
                --border-color: #404040;
                --border-light: #404040;
                --break-bg: #2d2d2d;
                --break-border: #505050;
                --break-text: #a0a0a0;
            }
        }

        @media (max-width: 1200px) {
            .timetable-grid {
                grid-template-columns: 60px repeat(5, 1fr);
                gap: 6px;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('grid')">Grid View</button>
            <button class="tab-button" onclick="switchTab('list')">List View</button>
        </div>

        <div id="grid-tab" class="tab-content active">
            <div class="controls">
                <button class="btn-save" onclick="saveTimetable()">üíæ Save Changes</button>
                <button class="btn-reset" onclick="resetTimetable()">üîÑ Reset</button>
            </div>

            <div class="timetable-grid" id="timetable"></div>
        </div>

        <div id="list-tab" class="tab-content">
            <div id="list-view"></div>
        </div>
    </div>

    <script>
        const DAY_NAMES = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
        const TIME_SLOTS = ["06:00", "07:00", "08:00", "09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00", "20:00", "21:00", "22:00"];
        const BREAK_DURATION = 120; // 2 hours in minutes

        // DATA_PLACEHOLDER_START
        let timetableData = {"Monday":[],"Tuesday":[],"Wednesday":[],"Thursday":[],"Friday":[]};
        // DATA_PLACEHOLDER_END
        
        // Ensure all days exist in the data
        function ensureAllDays(data) {
            for (let day of DAY_NAMES) {
                if (!data[day] || !Array.isArray(data[day])) {
                    data[day] = [];
                }
            }
            return data;
        }
        
        timetableData = ensureAllDays(timetableData);
        let originalData = JSON.parse(JSON.stringify(timetableData));
        let activityDeadlines = {}; // Store deadlines for activities
        let draggedElement = null;
        let draggedEventData = null;
        let originalDay = null;
        
        // Debug: Log the timetable data
        console.log('Timetable Data:', timetableData);
        console.log('Total events:', Object.values(timetableData).reduce((sum, day) => sum + day.length, 0));

        // Extract deadline information from activity names
        function extractDeadlines() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let day of DAY_NAMES) {
                if (!timetableData[day] || !Array.isArray(timetableData[day])) {
                    continue;
                }
                for (let event of timetableData[day]) {
                    if (event.type === 'ACTIVITY') {
                        // Store the day index this activity appears on
                        const dayIndex = DAY_NAMES.indexOf(day);
                        const baseName = event.name.replace(/ \(Session \d+\)/, '');
                        
                        if (!activityDeadlines[baseName] || dayIndex > activityDeadlines[baseName]) {
                            activityDeadlines[baseName] = dayIndex;
                        }
                    }
                }
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'grid') {
                document.querySelector('.tab-button:nth-child(1)').classList.add('active');
                document.getElementById('grid-tab').classList.add('active');
            } else {
                document.querySelector('.tab-button:nth-child(2)').classList.add('active');
                document.getElementById('list-tab').classList.add('active');
                renderListView();
            }
        }

        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        function getEventsInSlot(day, time) {
            if (!timetableData[day] || !Array.isArray(timetableData[day])) {
                return [];
            }
            const timeMinutes = timeToMinutes(time);
            return timetableData[day].filter(event => {
                const startMinutes = timeToMinutes(event.start);
                const endMinutes = timeToMinutes(event.end);
                return timeMinutes >= startMinutes && timeMinutes < endMinutes;
            });
        }

        function findBreakAfterEvent(day, eventEndTime) {
            if (!timetableData[day] || !Array.isArray(timetableData[day])) {
                return null;
            }
            const endMinutes = timeToMinutes(eventEndTime);
            return timetableData[day].find(event => 
                event.type === 'BREAK' && timeToMinutes(event.start) === endMinutes
            );
        }

        function removeBreakAfterEvent(day, eventEndTime) {
            if (!timetableData[day] || !Array.isArray(timetableData[day])) {
                return;
            }
            const breakEvent = findBreakAfterEvent(day, eventEndTime);
            if (breakEvent) {
                const index = timetableData[day].indexOf(breakEvent);
                if (index > -1) {
                    timetableData[day].splice(index, 1);
                }
            }
        }

        function addBreakAfterEvent(day, eventEndTime) {
            if (!timetableData[day]) {
                timetableData[day] = [];
            }
            
            const endMinutes = timeToMinutes(eventEndTime);
            const breakEndMinutes = endMinutes + BREAK_DURATION;
            
            if (breakEndMinutes >= 1440) return; // Don't add break past midnight
            
            const breakEnd = minutesToTime(breakEndMinutes);
            
            // Check if there's already a break at this time
            const existingBreak = findBreakAfterEvent(day, eventEndTime);
            if (existingBreak) return;
            
            // Check for conflicts
            const hasConflict = timetableData[day].some(event => {
                const eventStart = timeToMinutes(event.start);
                const eventEnd = timeToMinutes(event.end);
                return !(breakEndMinutes <= eventStart || endMinutes >= eventEnd);
            });
            
            if (!hasConflict) {
                timetableData[day].push({
                    start: eventEndTime,
                    end: breakEnd,
                    name: "Break",
                    type: "BREAK"
                });
                timetableData[day].sort((a, b) => timeToMinutes(a.start) - timeToMinutes(b.start));
            }
        }

        function renderTimetable() {
            extractDeadlines();
            const grid = document.getElementById('timetable');
            grid.innerHTML = '';

            grid.appendChild(createTimeLabel(''));
            DAY_NAMES.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = day;
                grid.appendChild(header);
            });

            TIME_SLOTS.forEach(time => {
                grid.appendChild(createTimeLabel(time));
                DAY_NAMES.forEach(day => {
                    const slot = createTimeSlot(day, time);
                    grid.appendChild(slot);
                });
            });
        }

        function createTimeLabel(time) {
            const label = document.createElement('div');
            label.className = 'time-label';
            label.textContent = time;
            return label;
        }

        function createTimeSlot(day, time) {
            const slot = document.createElement('div');
            slot.className = 'time-slot';
            slot.dataset.day = day;
            slot.dataset.time = time;

            const eventsInSlot = getEventsInSlot(day, time);
            eventsInSlot.forEach(event => {
                if (timeToMinutes(event.start) === timeToMinutes(time)) {
                    const card = createEventCard(event, day);
                    slot.appendChild(card);
                }
            });

            slot.addEventListener('dragover', handleDragOver);
            slot.addEventListener('drop', (e) => handleDrop(e, day, time));
            slot.addEventListener('dragleave', handleDragLeave);

            return slot;
        }

        function createEventCard(event, day) {
            const card = document.createElement('div');
            card.className = `event-card ${event.type.toLowerCase()}`;
            card.draggable = event.type !== 'COMPULSORY';

            // Check if activity is past its deadline
            if (event.type === 'ACTIVITY') {
                const baseName = event.name.replace(/ \(Session \d+\)/, '');
                const maxDayIndex = activityDeadlines[baseName];
                const currentDayIndex = DAY_NAMES.indexOf(day);
                
                if (maxDayIndex !== undefined && currentDayIndex > maxDayIndex) {
                    card.classList.add('past-deadline');
                }
            }

            const name = document.createElement('div');
            name.className = 'event-name';
            const emoji = event.type === 'COMPULSORY' ? 'üî¥' : event.type === 'ACTIVITY' ? 'üîµ' : '‚ö™';
            const warningEmoji = card.classList.contains('past-deadline') ? ' ‚ö†Ô∏è' : '';
            name.textContent = `${emoji} ${event.name}${warningEmoji}`;

            const time = document.createElement('div');
            time.className = 'event-time';
            time.textContent = `${event.start} - ${event.end}`;

            card.appendChild(name);
            card.appendChild(time);

            if (event.type !== 'COMPULSORY') {
                card.addEventListener('dragstart', (e) => handleDragStart(e, event, day));
                card.addEventListener('dragend', handleDragEnd);
            }

            return card;
        }

        function handleDragStart(e, event, day) {
            draggedElement = e.target;
            draggedEventData = {...event};
            originalDay = day;
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e, targetDay, targetTime) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            if (!draggedEventData || draggedEventData.type === 'COMPULSORY') return;
            
            // Ensure arrays exist
            if (!timetableData[targetDay]) timetableData[targetDay] = [];
            if (!timetableData[originalDay]) timetableData[originalDay] = [];

            // Check deadline constraint
            const baseName = draggedEventData.name.replace(/ \(Session \d+\)/, '');
            const maxDayIndex = activityDeadlines[baseName];
            const targetDayIndex = DAY_NAMES.indexOf(targetDay);
            
            if (maxDayIndex !== undefined && targetDayIndex > maxDayIndex) {
                alert('‚ö†Ô∏è Cannot move activity past its deadline!');
                return;
            }

            const duration = timeToMinutes(draggedEventData.end) - timeToMinutes(draggedEventData.start);
            const newStartMinutes = timeToMinutes(targetTime);
            const newEndMinutes = newStartMinutes + duration;
            const breakEndMinutes = newEndMinutes + BREAK_DURATION;
            
            const newStart = minutesToTime(newStartMinutes);
            const newEnd = minutesToTime(newEndMinutes);
            const breakEnd = minutesToTime(breakEndMinutes);

            // Check for conflicts with both activity and break
            const conflict = timetableData[targetDay].some(event => {
                const eventStart = timeToMinutes(event.start);
                const eventEnd = timeToMinutes(event.end);
                const isSameEvent = event.name === draggedEventData.name && event.start === draggedEventData.start;
                if (isSameEvent) return false;
                
                // Check if activity or its break would conflict
                return !(breakEndMinutes <= eventStart || newStartMinutes >= eventEnd);
            });

            if (conflict) {
                alert('‚ö†Ô∏è Time slot is occupied (including break time)!');
                return;
            }

            // Remove old break
            removeBreakAfterEvent(originalDay, draggedEventData.end);

            // Remove the activity from original day
            const eventIndex = timetableData[originalDay].findIndex(
                event => event.name === draggedEventData.name && 
                         event.start === draggedEventData.start && 
                         event.type === draggedEventData.type
            );
            
            if (eventIndex !== -1) {
                timetableData[originalDay].splice(eventIndex, 1);
            }

            // Add activity to new location
            timetableData[targetDay].push({
                ...draggedEventData,
                start: newStart,
                end: newEnd
            });

            // Add break after activity in new location
            addBreakAfterEvent(targetDay, newEnd);

            timetableData[targetDay].sort((a, b) => timeToMinutes(a.start) - timeToMinutes(b.start));

            renderTimetable();
        }

        function renderListView() {
            const listContainer = document.getElementById('list-view');
            listContainer.innerHTML = '';

            DAY_NAMES.forEach(day => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day-list';

                const title = document.createElement('div');
                title.className = 'day-title';
                title.textContent = `üìÖ ${day}`;
                dayDiv.appendChild(title);

                if (!timetableData[day] || !Array.isArray(timetableData[day]) || timetableData[day].length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'empty-day';
                    empty.textContent = 'No events scheduled';
                    dayDiv.appendChild(empty);
                } else {
                    timetableData[day].forEach(event => {
                        const item = document.createElement('div');
                        item.className = `event-list-item ${event.type.toLowerCase()}`;
                        
                        // Check if activity is past deadline
                        if (event.type === 'ACTIVITY') {
                            const baseName = event.name.replace(/ \(Session \d+\)/, '');
                            const maxDayIndex = activityDeadlines[baseName];
                            const currentDayIndex = DAY_NAMES.indexOf(day);
                            
                            if (maxDayIndex !== undefined && currentDayIndex > maxDayIndex) {
                                item.classList.add('past-deadline');
                            }
                        }
                        
                        const emoji = event.type === 'COMPULSORY' ? 'üî¥' : event.type === 'ACTIVITY' ? 'üîµ' : '‚ö™';
                        const warningEmoji = item.classList.contains('past-deadline') ? ' ‚ö†Ô∏è' : '';
                        item.innerHTML = `<strong>${emoji} ${event.name}${warningEmoji}</strong><span>${event.start} - ${event.end}</span>`;
                        dayDiv.appendChild(item);
                    });
                }

                listContainer.appendChild(dayDiv);
            });
        }

        function saveTimetable() {
            console.log('Timetable saved:', timetableData);
            alert('‚úÖ Timetable saved!');
        }

        function resetTimetable() {
            if (confirm('Reset timetable to original?')) {
                timetableData = JSON.parse(JSON.stringify(originalData));
                renderTimetable();
                if (document.getElementById('list-tab').classList.contains('active')) {
                    renderListView();
                }
            }
        }

        renderTimetable();
    </script>
</body>
</html>
